<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CarSaavy OPS Portal</title>
  <meta name="robots" content="noindex,nofollow" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 740px;
      margin: 32px auto;
      padding: 16px;
      background: #020617;
      color: #e5e7eb;
    }
    h1 {
      font-size: 1.4rem;
      margin-bottom: 0.25rem;
    }
    h2 {
      font-size: 1.1rem;
      margin-top: 1.5rem;
      margin-bottom: 0.5rem;
    }
    .muted {
      color: #9ca3af;
      font-size: 0.85rem;
    }
    .card {
      background: #0f172a;
      padding: 16px 20px;
      border-radius: 12px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.7);
      border: 1px solid #1e293b;
      margin-top: 16px;
    }
    label {
      display: block;
      font-size: 0.85rem;
      margin-top: 12px;
      margin-bottom: 4px;
      color: #9ca3af;
    }
    input[type="text"],
    input[type="email"],
    select,
    input[type="password"] {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #1f2933;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.9rem;
    }
    input[type="file"] {
      margin-top: 4px;
      font-size: 0.85rem;
    }
    .radio-row {
      display: flex;
      gap: 12px;
      margin-top: 4px;
    }
    .radio-row label {
      display: flex;
      align-items: center;
      gap: 4px;
      margin: 0;
    }
    button {
      margin-top: 16px;
      width: 100%;
      padding: 10px 0;
      border-radius: 999px;
      border: none;
      background: linear-gradient(90deg, #22c55e, #0ea5e9);
      color: #020617;
      font-weight: 600;
      cursor: pointer;
      font-size: 0.95rem;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    .status {
      margin-top: 10px;
      font-size: 0.85rem;
    }
    .status.ok {
      color: #4ade80;
    }
    .status.err {
      color: #f97373;
    }
    small {
      font-size: 0.75rem;
      color: #6b7280;
    }
    /* Login vs panel */
    #loginView,
    #panelView {
      display: none;
    }
    #loginView.active,
    #panelView.active {
      display: block;
    }
  </style>
</head>
<body>
  <header>
    <h1>CarSaavy OPS Portal</h1>
    <p class="muted">
      Internal manual fulfillment only. Bookmark this URL. Do not share publicly.
    </p>
  </header>

  <!-- LOGIN VIEW -->
  <div id="loginView" class="card active">
    <h2>Operator Login</h2>
    <p class="muted">
      Enter the OPS password (matches <code>OPS_PASSWORD</code> in your Vercel env).
    </p>
    <form id="loginForm">
      <label>
        Operator password
        <input type="password" id="loginPassword" required />
      </label>
      <button type="submit" id="loginBtn">Access Panel</button>
      <div id="loginStatus" class="status"></div>
    </form>
  </div>

  <!-- MAIN PANEL VIEW -->
  <div id="panelView" class="card">
    <h2>Manual Report Fulfillment</h2>
    <p class="muted">
      Send completed manual reports via Resend. Customers receive a PDF and an HTML copy.
    </p>

    <form id="fulfillForm">
      <label>
        Current OPS session (password in memory)
        <input type="password" id="opsPasswordDisplay" disabled />
        <small>Set when you log in above. Refresh the page to reset.</small>
      </label>

      <label>
        Order SKU (e.g. COMP-48-0005)
        <input type="text" id="sku" required />
      </label>

      <label>
        Customer full name
        <input type="text" id="fullName" required />
      </label>

      <label>
        Customer email
        <input type="email" id="email" required />
      </label>

      <label>
        Tier
        <select id="tier" required>
          <option value="essential">Essential</option>
          <option value="comprehensive">Comprehensive</option>
        </select>
      </label>

      <label>
        SLA hours
        <select id="slaHours" required>
          <option value="24">24h</option>
          <option value="48" selected>48h</option>
        </select>
      </label>

      <label> Email style </label>
      <div class="radio-row">
        <label>
          <input type="radio" name="mode" value="short" checked />
          Short
        </label>
        <label>
          <input type="radio" name="mode" value="branded" />
          Branded
        </label>
      </div>
      <small>Short = concise delivery email. Branded = more polished structure.</small>

      <label>
        PDF file
        <input type="file" id="pdfFile" accept="application/pdf" required />
      </label>

      <label>
        HTML file
        <input type="file" id="htmlFile" accept=".html,text/html" required />
        <small>This should be your final CarSaavy report HTML file.</small>
      </label>

      <button type="submit" id="sendBtn">Send via Resend</button>
      <div id="status" class="status"></div>
    </form>
  </div>

  <script>
    let opsPassword = null;

    const loginView = document.getElementById('loginView');
    const panelView = document.getElementById('panelView');
    const loginForm = document.getElementById('loginForm');
    const loginStatus = document.getElementById('loginStatus');
    const loginBtn = document.getElementById('loginBtn');
    const opsPasswordDisplay = document.getElementById('opsPasswordDisplay');

    const fulfillForm = document.getElementById('fulfillForm');
    const statusEl = document.getElementById('status');
    const sendBtn = document.getElementById('sendBtn');

    // Simple login: test the password by calling /api/ops?action=list
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      loginStatus.textContent = '';
      loginStatus.className = 'status';
      loginBtn.disabled = true;

      const pw = document.getElementById('loginPassword').value.trim();
      if (!pw) {
        loginStatus.textContent = 'Please enter a password.';
        loginStatus.className = 'status err';
        loginBtn.disabled = false;
        return;
      }

      try {
        const resp = await fetch('/api/ops', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'list',
            opsPassword: pw
          })
        });

        if (!resp.ok) {
          loginStatus.textContent = 'Incorrect password or API error.';
          loginStatus.className = 'status err';
          loginBtn.disabled = false;
          return;
        }

        // Success → store password in memory and show panel
        opsPassword = pw;
        opsPasswordDisplay.value = '••••••••'; // just to show "active", not the real value

        loginView.classList.remove('active');
        panelView.classList.add('active');

        loginStatus.textContent = '';
        loginStatus.className = 'status';
      } catch (err) {
        console.error(err);
        loginStatus.textContent = 'Network error.';
        loginStatus.className = 'status err';
      } finally {
        loginBtn.disabled = false;
      }
    });

    // Fulfillment form
    fulfillForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      statusEl.textContent = '';
      statusEl.className = 'status';
      sendBtn.disabled = true;

      try {
        if (!opsPassword) {
          throw new Error('You must log in first.');
        }

        const sku = document.getElementById('sku').value.trim();
        const fullName = document.getElementById('fullName').value.trim();
        const email = document.getElementById('email').value.trim();
        const tier = document.getElementById('tier').value;
        const slaHours = document.getElementById('slaHours').value;
        const mode = [...document.querySelectorAll('input[name="mode"]')]
          .find(r => r.checked).value;

        const pdfFile = document.getElementById('pdfFile').files[0];
        const htmlFile = document.getElementById('htmlFile').files[0];

        if (!sku || !fullName || !email) {
          throw new Error('SKU, name, and email are required.');
        }
        if (!pdfFile || !htmlFile) {
          throw new Error('Please attach both PDF and HTML files.');
        }

        const readFileAsBase64 = (file) => {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => {
              const base64 = reader.result.split(',')[1];
              resolve(base64);
            };
            reader.onerror = reject;
            reader.readAsDataURL(file);
          });
        };

        const readFileAsText = (file) => {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsText(file);
          });
        };

        const [pdfBase64, htmlContent] = await Promise.all([
          readFileAsBase64(pdfFile),
          readFileAsText(htmlFile)
        ]);

        const payload = {
          action: 'fulfill',
          opsPassword,
          sku,
          fullName,
          email,
          tier,
          slaHours: Number(slaHours),
          mode,
          pdf: {
            filename: pdfFile.name,
            base64: pdfBase64
          },
          html: {
            filename: htmlFile.name,
            content: htmlContent
          }
        };

        const resp = await fetch('/api/ops', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const data = await resp.json();

        if (!resp.ok) {
          throw new Error(data.error || 'Unknown error from API');
        }

        statusEl.textContent = 'Sent successfully ✅';
        statusEl.className = 'status ok';
        fulfillForm.reset();
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'Error: ' + err.message;
        statusEl.className = 'status err';
      } finally {
        sendBtn.disabled = false;
      }
    });
  </script>
</body>
</html>